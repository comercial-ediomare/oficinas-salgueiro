<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Inscrição nas Oficinas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 2rem auto; max-width: 860px; color: #222; padding: 0 1rem; }
    h1 { text-align: center; margin-bottom: 1rem; color: #004b6b; }
    form { margin-top: 1rem; }
    fieldset.slot { margin: 1.25em 0; padding: 1em; border: 2px solid #ccc; border-radius: 10px; }
    legend { font-weight: bold; color: #333; }
    label { display: block; margin-bottom: .45em; }
    label.bloqueada { color: #888; }
    label.bloqueada small { color: #aaa; }
    .flash { padding: 1em; border-radius: 6px; margin-bottom: 1em; }
    .flash.error { background: #ffe0e0; color: #a00; border: 1px solid #f99; }
    .flash.message { background: #e0f8e0; color: #060; border: 1px solid #9c9; }
    input[type="text"], input[type="email"] { width: 100%; padding: .6em; border: 1px solid #bbb; border-radius: 6px; margin-top: .25em; }
    button { background: #0074a6; color: #fff; border: none; padding: .75em 1.5em; border-radius: 6px; font-size: 1rem; cursor: pointer; margin-top: 1rem; }
    button:hover { background: #005c83; }
    small.muted { color: #666; }
  </style>
</head>
<body>
  <h1>Inscrição nas Oficinas</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
        <div class="flash {{ cat }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="post" action="{{ url_for('inscrever') }}">
    <label>Nome completo:
      <input type="text" name="full_name" required>
    </label>

    <label style="margin-top:.6em;">E-mail:
      <input type="email" name="email" required>
    </label>

    <p><strong>Escolha de 1 a 4 oficinas (máximo 1 por horário e sem repetir):</strong></p>

    {% for slot in slots %}
      <fieldset class="slot">
        <legend>{{ loop.index }}º Horário — {{ slot.hora }}</legend>
        <div class="oficinas">
          {% for w in workshops %}
            {% if w["name"] not in slot.bloqueadas %}
              <label>
                <input type="radio"
                       class="opt"
                       name="slot_{{ slot.id }}"
                       value="{{ w['id'] }}"
                       data-workshop-id="{{ w['id'] }}"
                       data-slot-id="{{ slot.id }}"
                       onchange="updateSlots()">
                {{ w["name"] }}
                <small class="muted">({{ w["registered"] }}/{{ w["capacity"] }} vagas ocupadas)</small>
              </label>
            {% else %}
              <label class="bloqueada">
                <input type="radio" disabled>
                {{ w["name"] }} <small class="muted">(não disponível neste horário)</small>
              </label>
            {% endif %}
          {% endfor %}
          <!-- opção de não escolher nada neste horário -->
          <label>
            <input type="radio"
                   class="opt"
                   name="slot_{{ slot.id }}"
                   value=""
                   data-slot-id="{{ slot.id }}"
                   onchange="updateSlots()">
            Não escolher neste horário
          </label>
        </div>
      </fieldset>
    {% endfor %}

    <p>
      <label>
        <input type="checkbox" name="consent" required>
        Autorizo o uso dos meus dados para organização das oficinas.
      </label>
    </p>

    <button type="submit" id="submitBtn" disabled>Enviar inscrição</button>
  </form>

  <script>
    function updateSlots() {
      // Agrupa radios por oficina (mesmo ID em slots diferentes)
      const radios = Array.from(document.querySelectorAll('input[type="radio"].opt'));
      const byWorkshop = new Map(); // id -> [radios]
      radios.forEach(r => {
        const wid = r.dataset.workshopId;
        if (!wid) return; // ignora "Não escolher neste horário"
        if (!byWorkshop.has(wid)) byWorkshop.set(wid, []);
        byWorkshop.get(wid).push(r);
      });

      // Primeiro, reabilita tudo que não está bloqueado por horário (não tocamos nos desabilitados do HTML)
      byWorkshop.forEach(list => {
        list.forEach(r => {
          // só reabilita se não estiver desabilitado pelo HTML (bloqueio por horário):
          // nosso seletor 'opt' só pega os habilitáveis, então ok reabilitar
          r.disabled = false;
        });
      });

      // Para cada oficina: se ela foi escolhida em algum slot, desabilita as opções dessa mesma oficina nos outros slots
      byWorkshop.forEach(list => {
        const checked = list.find(r => r.checked && r.value);
        if (checked) {
          list.forEach(r => {
            if (r !== checked) r.disabled = true;
          });
        }
      });

      // Habilita o submit se nº de escolhas (com valor) ∈ [1,4]
      const chosenCount = Array.from(document.querySelectorAll('input[type="radio"][name^="slot_"]:checked'))
                               .filter(r => r.value).length;
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = !(chosenCount >= 1 && chosenCount <= 4);
    }

    document.addEventListener('DOMContentLoaded', updateSlots);
  </script>
</body>
</html>
