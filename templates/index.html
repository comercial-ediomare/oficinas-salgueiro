<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inscrição nas Oficinas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 2rem auto;
      padding: 1rem;
      background: #f8f9fa;
    }
    h1 {
      color: #222;
      text-align: center;
    }
    form {
      background: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
    }
    section {
      margin-top: 1.5rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fafafa;
    }
    section h3 {
      margin-top: 0;
      color: #003366;
    }
    label {
      display: block;
      margin: .3rem 0;
      cursor: pointer;
    }
    small {
      color: #a00;
    }
    .btn {
      background: #003366;
      color: #fff;
      padding: .75rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 1rem;
    }
    .btn:hover {
      background: #00509e;
    }
    .msg {
      margin-bottom: 1rem;
      padding: .5rem;
      border-radius: 4px;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
    .message {
      background: #d4edda;
      color: #155724;
    }
    .muted {
      color:#666; font-style: italic;
    }
  </style>
</head>
<body>
  <h1>Inscrição nas Oficinas</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
        <div class="msg {{ cat }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="post" action="{{ url_for('inscrever') }}">
    <label>Nome completo:
      <input type="text" name="full_name" required style="width:100%; padding:.5rem; margin-top:.25rem;">
    </label>

    <label>E-mail:
      <input type="email" name="email" required style="width:100%; padding:.5rem; margin-top:.25rem;">
    </label>

    <!-- HORÁRIOS -->
    {% for slot in slots %}
      <section>
        <h3>{{ loop.index }}º Horário — {{ slot.hora }}</h3>

        <!-- Opção: não escolher nesse horário -->
        <label class="muted">
          <input type="radio"
                 name="slot_{{ slot.id }}"
                 value=""
                 class="slot-none"
                 data-slot="{{ slot.id }}"
                 checked>
          Não escolher neste horário
        </label>

        {% set bloqueadas = slot.bloqueadas %}
        {% for w in workshops %}
          {% set disabled = (w.name in bloqueadas) %}
          <label>
            <input type="radio"
                   name="slot_{{ slot.id }}"
                   value="{{ w.id }}"
                   {% if disabled %}disabled{% endif %}
                   class="oficina-radio"
                   data-wid="{{ w.id }}"
                   data-slot="{{ slot.id }}">
            {{ w.name }}
            {% if disabled %}
              <small>(indisponível neste horário)</small>
            {% endif %}
          </label>
        {% endfor %}
      </section>
    {% endfor %}

    <p class="muted" style="margin-top:.75rem;">
      * Você pode escolher de 1 até 4 oficinas (no máximo uma por horário).
    </p>

    <label style="margin-top:1rem;">
      <input type="checkbox" name="consent" required>
      Concordo com o tratamento dos meus dados conforme a LGPD.
    </label>

    <button type="submit" class="btn">Enviar Inscrição</button>
  </form>

  <script>
    // Regras:
    // 1) Uma oficina não pode ser escolhida em dois horários diferentes.
    // 2) Há opção "Não escolher neste horário" por slot.
    // 3) Ao escolher uma oficina em um slot, as mesmas oficinas ficam desabilitadas nos outros slots.
    // 4) Se você desmarca (seleciona "não escolher"), reabilita nos outros slots.

    const radios = Array.from(document.querySelectorAll('.oficina-radio'));
    const noneRadios = Array.from(document.querySelectorAll('.slot-none'));

    function getSelections() {
      // Retorna { slotId: wid || "" }
      const selections = {};
      // Coleta por name=slot_X
      const slotNames = new Set(
        Array.from(document.querySelectorAll('input[type="radio"]'))
          .map(i => i.name)
          .filter(n => n.startsWith('slot_'))
      );
      slotNames.forEach(name => {
        const checked = document.querySelector(`input[name="${name}"]:checked`);
        if (checked) {
          selections[name.replace('slot_', '')] = checked.value; // "" ou wid
        }
      });
      return selections;
    }

    function updateDisabled() {
      const selections = getSelections(); // { "1": "3", "2": "", "3": "5", ... }
      // Conjunto com os WIDs escolhidos (excluindo vazios e inválidos)
      const chosenWids = new Set(
        Object.values(selections).filter(v => v && /^\d+$/.test(v))
      );

      // Para cada radio de oficina:
      radios.forEach(r => {
        const wid = r.dataset.wid;         // id da oficina desse radio
        const slot = r.dataset.slot;       // slot atual (string)
        const current = selections[slot];  // o que está selecionado nesse slot

        // Regra: desabilita se a mesma oficina está escolhida em OUTRO slot
        // (mas não desabilita o que já está marcado no próprio slot)
        const isChosenElsewhere = chosenWids.has(wid) && current !== wid;

        // Mantém desabilitado se já estava desabilitado por "bloqueadas"
        const originallyDisabled = r.hasAttribute('disabled');

        if (!originallyDisabled) {
          r.disabled = isChosenElsewhere;
        }
      });
    }

    // Listeners de mudança
    radios.forEach(r => r.addEventListener('change', updateDisabled));
    noneRadios.forEach(r => r.addEventListener('change', updateDisabled));

    // Inicializa regras ao carregar
    updateDisabled();
  </script>
</body>
</html>
